
if (!document.getElementById('ptk_recording_control') && !window.opener) {

    browser.storage.local.get(['ptk_recording', 'ptk_replay']).then(function (result) {
        let popupHtml = document.getElementById('ptk_recording_control')
        
        let icon = `url('data:image/png;base64,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')`
        if(result.ptk_replay?.mode == 'replay')
            icon = `url('data:image/png;base64,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')`
            popupHtml = document.createElement('div')
        popupHtml.id = 'ptk_recording_control';
        popupHtml.innerHTML = `
        <style>
            #ptk_recording_control{
                position:absolute; top:10px; right: 10px; width: 50px;height: 50px; border-radius: 50%;z-index:10000;
                background: gray;text-align: center;display: flex;justify-content: center;align-items: center;
            }
            #ptk_recording_control_icon {
               width: 45px;height: 45px; border-radius: 50%;z-index:10000;cursor: move;
                animation:3s blinker linear infinite;-webkit-animation:3s blinker linear infinite;-moz-animation:3s blinker linear infinite;
                background-image: ${icon};
                background-color:black; background-position: center; background-repeat: no-repeat;background-size: 40px 40px;
                text-align: center;display: flex;justify-content: center;align-items: flex-end;
            }
            @-moz-keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }
            @-webkit-keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }
            @keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }
        </style>
        <div id="ptk_recording_control_icon"></div>
        <div id="ptk_recording_message"></div>
        `;

        (document.documentElement).appendChild(popupHtml)

        let popupScript = document.createElement('script')
        popupScript.textContent = `
    (function(){
        let SCROLL_WIDTH = 24, offset = { x: 0, y: 0 }
        let ptk_recording_control = document.getElementById("ptk_recording_control")
      
        ptk_recording_control.addEventListener('mousedown', mouseDown, false)
        window.addEventListener('mouseup', mouseUp, false)
      
        function mouseUp() { window.removeEventListener('mousemove', popupMove, true) }
      
        function mouseDown(e){
          offset.x = e.clientX - ptk_recording_control.offsetLeft
          offset.y = e.clientY - ptk_recording_control.offsetTop
          window.addEventListener('mousemove', popupMove, true)
        }
      
        function popupMove(e){
          ptk_recording_control.style.position = 'absolute'
          let top = e.clientY - offset.y, left = e.clientX - offset.x
          ptk_recording_control.style.top = top + 'px'
          ptk_recording_control.style.left = left + 'px'
        }
      }())
    `;
        (document.head).appendChild(popupScript)


        function showMessage(item) {
            document.getElementById('ptk_recording_message').innerText = ''//'Recorded: ' + item?.eventTypeName
        }

        browser.storage.onChanged.addListener(function (changes, namespace) {
            if (changes['ptk_recording_items']) {
                let changedValue = changes['ptk_recording_items'].newValue
                let item = changedValue[changedValue.length - 1]
                showMessage(item)
            }
        })
    })

}