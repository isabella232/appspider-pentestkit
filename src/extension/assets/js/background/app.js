/* Author: Denis Podgurskii */

import { ptk_utils } from "./utils.js"
import { ptk_settings } from "./settings.js"
import { ptk_recorder } from "./recorder.js"
import { ptk_tabs } from "./tab.js"
import { ptk_rattacker } from "./rattacker.js"
import { ptk_request } from "./request.js"
import { ptk_integration } from "./integration.js"

export class ptk_app {
    constructor(config) {
        this.config = config
        
        browser.storage.local.get('pentestkit_settings').then(function (result) {

            this.settings = new ptk_settings()
            if (result.pentestkit_settings) {
                this.settings.mergeSettings(result.pentestkit_settings)
            }

            if (this.config.tabs_tracking) {
                this.tabs = new ptk_tabs(
                    this.settings.main.general.max_tabs,
                    this.settings.main.general.max_requests_per_tab,
                    this.settings.main.general.tabs_capturing
                )
            }

            if (this.config.rattacker) {
                this.rattacker = new ptk_rattacker()
            }

            this.recorder = new ptk_recorder()
            this.request = new ptk_request()

            //this.integration = new ptk_integration(this.config.integration.channel)

            this.filterType = ["main_frame", "sub_frame", "stylesheet", "script", "image", "font", "object", "xmlhttprequest", "ping", "csp_report", "media", "websocket", "other"]
            this.extraHeaders = window.isFirefox ? [] : ["extraHeaders"]
            this.addMessageListeners()

        }.bind(this))
    }

    addMessageListeners() {
        browser.runtime.onMessage.addListener(function (message, sender, sendResponse) {
            if (message.channel == "ptk_popup2background_app") {
                if (message.type == "on_updated_settings") {
                    this.tabs.maxTabsCount = this.settings.main.general.max_tabs
                    this.tabs.maxRequestsPerTab = this.settings.main.general.max_requests_per_tab
                    this.tabs.isTabsCapturingActive = this.settings.main.general.tabs_capturing
                }
            }
        }.bind(this))
    }
}

