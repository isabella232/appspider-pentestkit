/* Author: Denis Podgurskii */

browser.runtime.onMessage.addListener(function (message, sender, sendResponse) {

    if (message.channel == "ptkPopupToContent" && message.type == "init") {
        var m = document.createElement('meta');
        m.id = 'pentestkitMetaId';
        m.content = message.headers;
        (document.head || document.documentElement).appendChild(m);

        var s = document.createElement('script');
        s.src = browser.runtime.getURL(message.detector);
        s.id = "pentestkitDetectorId";
        (document.head || document.documentElement).appendChild(s);


        m.addEventListener('ready', function (event) {
            var m = document.getElementById("pentestkitMetaId")
            m.parentNode.removeChild(m)
            var s = document.getElementById("pentestkitDetectorId")
            s.parentNode.removeChild(s)

            // HTML
            var clientHtml = new XMLSerializer().serializeToString(document).split('\n')

            clientHtml = clientHtml
                .slice(0, 1000).concat(clientHtml.slice(clientHtml.length - 1000))
                .map(line => line.substring(0, 1000))
                .join('\n')

            // Scripts
            const clientScripts = Array.prototype.slice
                .apply(document.scripts)
                .filter(script => script.src)
                .map(script => script.src)
                .filter(script => script.indexOf('data:text/javascript;') !== 0)


            browser.runtime.sendMessage({
                channel: "ptkContentToPopup",
                type: "complete",
                apps: m.content,
                html: clientHtml,
                scripts: clientScripts
            }).catch(e => console.log(e))

        })
    }
    // if (message.channel != "ptkPopupToContent" && message.type == "init") {
    // }
})





