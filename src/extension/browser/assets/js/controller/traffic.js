/* Author: Denis Podgurskii */

import { ptk_exporter } from "../../../../assets/js/background/exporter.js"

export class ptk_controller_traffic {
    constructor() {
        this.settings = {}
        this.recording = null
    }

    getSettings() {
        let self = this
        return browser.runtime.sendMessage({ channel: "ptk_popup2background_settings", type: "get_settings", path: "traffic" })
            .then(function (response) {
                Object.assign(self.settings, response)
                return response.settings
            })
    }

    init() {
        let self = this
        self.getSettings()
        return browser.runtime.sendMessage({ channel: "ptk_popup2background_recorder", type: "init" })
            .then(response => {
                Object.assign(self, response)
                return response
            })
    }

    reset() {
        return browser.runtime.sendMessage({ channel: "ptk_popup2background_recorder", type: "reset" })
            .then(response => {
                return response
            })
    }

    start(cleanCookie, url) {
        return browser.runtime.sendMessage({ channel: "ptk_popup2background_recorder", type: "start_traffic", cleanCookie: cleanCookie, url: url })
            .then(response => {
                return response
            })
    }

    export() {
        if (this.recording) {
            let exporter = new ptk_exporter(this.recording.items, this.recording.frames, this.settings)
            return exporter.render()
        }
    }

    analyse() {
        return browser.runtime.sendMessage({ channel: "ptk_popup2background_recorder", type: "analyse" })
            .then(response => {
                return response
            })
    }

    export() {
        if (this.recording) {
            console.log(this.recording.recordingRequests)
            let exporter = new ptk_exporter(this.recording, this.settings)
            return exporter.render()
        }
    }

}

