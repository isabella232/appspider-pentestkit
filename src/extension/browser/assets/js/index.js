/* Author: Denis Podgurskii */
import { indexController } from "./controller/index.js"

jQuery(function () {

    $('#reload').on('click', function () {
        indexController.run()
    })

    $('.item.clean').on('click', function () {
        ptk_app.tabs.clearTab(ptk_app.tabs.activeTab.tabId)
        indexController.run()
    })

    $("input[name='deactivate_capturing']").on('change', e => {
        var $form = $('#dashboard_form'), values = $form.form('get values')

        if (values['deactivate_capturing'] == 'on')
            ptk_app.tabs.deactivateTabsCapturing()
        else
            ptk_app.tabs.activateTabsCapturing()
    })


    $('#send_to_request').on('click', function () {
        window.location.href = "requestbuilder.html?frameId=" + $('#details_frameId').val() + '&requestId=' + $('#details_requestId').val() + '&index=' + $('#details_index').val()
    })

    $(document).on("click", ".request_details", function () {
        var table = $(this).closest('table').DataTable(),
            tr = $(this).closest('tr'),
            row = table.row(tr),
            values = table.row($(this).parents('tr')).data()
        window.location.href = "requestbuilder.html?frameId=" + values[3] + '&requestId=' + values[2] + '&index=' + values[1]
    })

    $(document).on("click", "#download_domain_list", function () {
        var data = indexController.getDomainList()
        if (data != null) {
            var blob = new Blob([data.join("\r\n")], { type: 'text/plain' })
            var downloadLink = document.createElement("a")
            downloadLink.download = "PTK_domain_list"
            downloadLink.innerHTML = "Download File"
            downloadLink.href = window.URL.createObjectURL(blob)
            downloadLink.click()
        }
    })

    $(document).on("click", "#download_url_list", function () {
        var data = indexController.getUrlList()
        if (data != null) {
            var blob = new Blob([data.join("\r\n")], { type: 'text/plain' })
            var downloadLink = document.createElement("a")
            downloadLink.download = "PTK_url_list"
            downloadLink.innerHTML = "Download File"
            downloadLink.href = window.URL.createObjectURL(blob)
            downloadLink.click()
        }
    })





    indexController.run().then(function (result){
        console.log(result)
    })
})

/* Chrome runtime events handlers */

browser.runtime.onMessage.addListener(function (message, sender, sendResponse) {
    
    // if (message.channel == "ptk_content2popup" && message.type == "complete") {
    //     browser.tabs.get(ptk_app.tabs.activeTab.tabId).then(function (tab) {
    //         indexController.complete(tab, message)
    //     })
    // }

    if (message.channel == "ptkBackgroundToPopup" && message.type == "active tab changed") {
        if ($("input[name='reload_on_active']").parent().checkbox('is checked')) {
            indexController.run()
        }
    }
    if (message.channel == "ptkBackgroundToPopup" && message.type == "requests source resized") {
        indexController.bindFrames()
    }


})

