'use strict';
(function () {


    var frames = document.getElementsByTagName('iframe');
    var framesCollection = [];
    if (frames && frames.length) {
        for (var i = 0; i < frames.length; i++) {
            if (frames[i].name || frames[i].id || frames[i].title) {
                framesCollection.push({
                    index: i + 1,
                    name: frames[i].name ? frames[i].name : "",
                    id: frames[i].id ? frames[i].id : "",
                    title: frames[i].title ? frames[i].title : ""
                });
            }
            else {

            }

        }
    }
    browser.runtime.sendMessage({
        channel: 'ptkRecorderToBackground',
        function: 'framesCollection',
        parameters: { frames: framesCollection }
    }).catch(e => e);;

    var popupHtml = document.getElementById('PTK_RecordingMessageCenter');

    if (!popupHtml) {
        popupHtml = document.createElement('div');
        popupHtml.id = 'PTK_RecordingMessageCenter';
        popupHtml.className = 'PTK_RecordingMessageCenter';
        popupHtml.innerHTML = `
<style>
#PTK_RecordingMessageCenter {
  all: initial;
  
  line-height: 25px; text-align: center; text-decoration: none;
  font-weight: bold; -webkit-border-radius: 12px; -moz-border-radius: 12px;
  border-radius: 12px; -moz-box-shadow: 1px 1px 3px #000; -webkit-box-shadow: 1px 1px 3px #000; box-shadow: 1px 1px 3px #000;
  position: fixed; top: 10px; left: 10px; width: 280px; height: 120px; 
  z-index: 1000000000000;
  resize: both;
  overflow: hidden;
  min-width: 225px; min-height:90px; 

}
#PTK_RecordingMessageCenter_Header{
    background-color: #5c5c5c; 
    height: 35px;
}
#PTK_RecordingMessageCenter_Text{
  animation:3s blinker linear infinite;
  -webkit-animation:3s blinker linear infinite;
  -moz-animation:3s blinker linear infinite;
  color: #FFF7A8;
  width:100%;
  cursor: move;
  line-height: 37px;
}

#PTK_RecordingMessageCenter_Message{
    background: rgba(225, 226, 223, 0.88); ; color: black; line-height: 25px; text-align: center; text-decoration: none;
    height: 100%;
    font-size:12px; text-align:left; font-weigth:100;
    border-bottom-left-radius: 12px; -moz-box-shadow: 1px 1px 3px #000; -webkit-box-shadow: 1px 1px 3px #000; box-shadow: 1px 1px 3px #000;
    border-bottom-right-radius: 12px; -moz-box-shadow: 1px 1px 3px #000; -webkit-box-shadow: 1px 1px 3px #000; box-shadow: 1px 1px 3px #000;
    overflow:hidden;
}

#PTK_RecordingMessageCenter_Message div.ptk_message_table{
    display: table;
    all: initial;
    font-size: 12px;
    padding-left: 7px;
    font-family: monospace;
    line-height: 24px;
    margin-top: 100px;
    line-height:20px;
    
}

#PTK_RecordingMessageCenter_Icon{
    position: absolute; width: 30px; height: 30px; top: 1px; left: 2px; z-index:100;
}
#PTK_RecordingMessageCenter_StopIcon{
    position: absolute; width: 30px; height: 30px; top: 1px; right: 2px; z-index:100;
    cursor: pointer;
}

@-moz-keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }
@-webkit-keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }
@keyframes blinker {  0% { opacity: 1.0; } 50% { opacity: 0.0; } 100% { opacity: 1.0; } }


</style>
<div id="PTK_RecordingMessageCenter_Header">
    <img id="PTK_RecordingMessageCenter_Icon" src="data:image/png;base64,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" 
  title="Penetration Testing Kit" /> 
     <span id="PTK_RecordingMessageCenter_Text">Operation in progress</span> 
    <img id="PTK_RecordingMessageCenter_StopIcon" src="data:image/png;base64,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" 
  title="Stop recording" /> 
  </div>
<div id="PTK_RecordingMessageCenter_Message">
</div>
`;

        (document.documentElement).appendChild(popupHtml);

        var popupScript = document.createElement('script');
        popupScript.textContent = `
    var PTK_RecordingMessageCenter = document.getElementById('PTK_RecordingMessageCenter');
    var PTK_RecordingMessageCenter_Text = document.getElementById('PTK_RecordingMessageCenter_Text');
    PTK_RecordingMessageCenter_Text.onmousedown = function (event) {
        let shiftX = event.clientX - PTK_RecordingMessageCenter.getBoundingClientRect().left;
        let shiftY = event.clientY - PTK_RecordingMessageCenter.getBoundingClientRect().top;

        function moveAt(pageX, pageY) {
            PTK_RecordingMessageCenter.style.left = pageX - shiftX + 'px';
            PTK_RecordingMessageCenter.style.top = pageY - shiftY + 'px';
        }
        function onMouseMove(event) {
            moveAt(event.clientX, event.clientY);
        }
        document.addEventListener('mousemove', onMouseMove);
        PTK_RecordingMessageCenter_Text.onmouseup = function (event) {
            document.removeEventListener('mousemove', onMouseMove);
            PTK_RecordingMessageCenter_Text.onmouseup = null;
        };
    };
`;
        (document.head).appendChild(popupScript);

        document.getElementById('PTK_RecordingMessageCenter_StopIcon').onclick = function (event) {
            browser.runtime.sendMessage({
                channel: 'pentestkitAppSpiderRecorderChannel',
                function: 'stop',
                parameters: {}
            }).catch(e => e);;
        };




        function showMessage(mode, item) {
            var msg = "", eventName = "", xpath = "", fullxpath = "", cssselector = "", fullcssselector = "";
            var msgCenter = document.getElementById('PTK_RecordingMessageCenter_Message');
            document.getElementById('PTK_RecordingMessageCenter_Text').innerText = (mode == "replay" ? "Playback in progress" : "Recording in progress");
            if (mode == 'recording') {
                eventName = item.eventTypeName;
                xpath = (item.info && item.info.xpath) ? item.info.xpath : "";
                fullxpath = (item.info && item.info.fullxpath) ? item.info.fullxpath : "";
                cssselector = (item.info && item.info.cssselector) ? item.info.cssselector : "";
                fullcssselector = (item.info && item.info.fullcssselector) ? item.info.fullcssselector : "";
                msg = `   
                    <div class="ptk_message_table">
                        <div style="display: table-row;">
                            <div style="display: table-cell;">Event</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_EVENT_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;">xPath</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_XPATH_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;min-width: 90px;">Full xPath</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_FULLXPATH_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;">CSS</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_CSS_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;">Full CSS</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_fullCSS_ptk</i></div>
                        </div>
                    </div>`.replace('ptk_EVENT_ptk', eventName)
                    .replace('ptk_XPATH_ptk', xpath)
                    .replace('ptk_FULLXPATH_ptk', fullxpath)
                    .replace('ptk_CSS_ptk', cssselector)
                    .replace('ptk_fullCSS_ptk', fullcssselector);
            } else if (mode == 'replay') {
                msg = `   
                    <div class="ptk_message_table">
                        <div style="display: table-row;">
                            <div style="display: table-cell;">Step</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_STEP_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;min-width: 90px;">Event</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_EVENT_ptk</i></div>
                        </div>
                        <div style="display: table-row;">
                            <div style="display: table-cell;">xPath</div><div style="display: table-cell;">&nbsp;</div><div style="display: table-cell;"><i>ptk_XPATH_ptk</i></div>
                        </div>
                    </div>`.replace('ptk_STEP_ptk', item.replayStep)
                    .replace('ptk_EVENT_ptk', item.EventType)
                    .replace('ptk_XPATH_ptk', item.ElementPath);

            }
            msgCenter.innerHTML = msg;
        }

        window.addEventListener("message", (event) => {
            if (event.data.channelName == 'PTK_recorder_runtime' && event.data.message == 'replay completed') {
                browser.storage.local.get('pentestkit_recording').then(function (result) {
                    var storage = result.pentestkit_recording;
                    var msgCenter = document.getElementById('PTK_RecordingMessageCenter_Message');

                    msgCenter.innerHTML = `   
                    <div class="ptk_message_table">
                        <div style="display: table-row;">
                            <div style="display: table-cell;">Macro playback completed. Window will be closed in <span id="PTK_RecordingMessageCenter_Timer">10</span></div>
                        </div>
                    </div>`;
                    setInterval(function () {
                        var timer = document.getElementById('PTK_RecordingMessageCenter_Timer');
                        var val = parseInt(timer.innerText);
                        timer.innerText = val - 1;
                    }, 1000);

                    setTimeout(function () {
                        browser.runtime.sendMessage({
                            channel: 'pentestkitAppSpiderRecorderChannel',
                            function: 'stop',
                            parameters: {}
                        }).catch(e => e);;
                    }, 10000);
                });
            }
        });

        browser.storage.onChanged.addListener(function (changes, namespace) {
            if (changes['pentestkit_recording']) {
                var changedValue = changes['pentestkit_recording'].newValue;
                let item;
                if (changedValue.mode == 'recording') {
                    item = changedValue.items[changedValue.items.length - 1];
                } else if (changedValue.mode == 'replay') {
                    item = changedValue.replayItems[changedValue.replayStep - 1];
                    item.replayStep = changedValue.replayStep;
                }

                if (item) {
                    showMessage(changedValue.mode, item);
                }
            }
        });


    }
})();
