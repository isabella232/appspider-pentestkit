/* Author: Denis Podgurskii */
'use strict';

chrome.runtime.onMessage.addListener(
    function(request, sender, sendResponse) {

        if (request.type == "init") {
            console.log("init");
            var meta = document.createElement('meta');
            meta.id = 'pentestkitMetaId';
            meta.content = request.responseHeaders;
            (document.head || document.documentElement).appendChild(meta);

            var sDict = document.createElement('script');
            sDict.onload = function() {
                var sDetector = document.createElement('script');
                sDetector.src = chrome.extension.getURL(request.detector);
                sDetector.id = "pentestkitDetectorId";
                (document.head || document.documentElement).appendChild(sDetector);
            };
            sDict.src = chrome.extension.getURL(request.dictionary);
            sDict.id = "pentestkitDictionaryId";
            (document.head || document.documentElement).appendChild(sDict);

            meta.addEventListener('ready', function(event) {

                var s = document.getElementById("pentestkitDictionaryId");
                s.parentNode.removeChild(s);
                s = document.getElementById("pentestkitDetectorId");
                s.parentNode.removeChild(s);
                var m = document.getElementById("pentestkitMetaId");
                m.parentNode.removeChild(m);

                // HTML
                var clientHtml = new XMLSerializer().serializeToString(document).split('\n');

                clientHtml = clientHtml
                    .slice(0, 1000).concat(clientHtml.slice(clientHtml.length - 1000))
                    .map(line => line.substring(0, 1000))
                    .join('\n');

                // Scripts
                const clientScripts = Array.prototype.slice
                    .apply(document.scripts)
                    .filter(script => script.src)
                    .map(script => script.src)
                    .filter(script => script.indexOf('data:text/javascript;') !== 0);

                chrome.runtime.sendMessage({ type: "complete", apps: meta.content, html: clientHtml, scripts: clientScripts });

            });
        }
    });