/* Author: Denis Podgurskii */
'use strict';

var _debug = false;
var filter_types = ["main_frame", "sub_frame", "stylesheet", "script", "object", "xmlhttprequest", "ping", "websocket", "other"];
var contexts = ["browser_action", "page", "selection", "link"];


////////////////////////////////////
/* Proxy for all background scripts */
////////////////////////////////////
var BackgroundProxy = {

    excludedTabs: [],

    tabs: [],
    //plugins: ["analyzer", "macro", "request"],
    detector: "assets/js/detector.js",
    dictionary: "assets/js/dictionary.js",

    _settings: null,
    _activeTab: null,
    _previousTab: null,


    ////////////////////////////////////
    setTab: function(tabId, params, type) {
        if (type != 'clientApps') {
            //check tabs capturing activated
            if (!this.BrowserActions.isTabsCapturingActive) return;
            //Do nothing for excluded tabs
            if (tabId in this.excludedTabs) return;
            //Listen only active tab
            if (this.activeTab == null || tabId != this.activeTab.tabId) return;
            //do not add own requests
            if (typeof params.url != 'undefined' && params.url.indexOf(chrome.runtime.id) > -1) return;
        }
        try {
            console.log(type);
            console.log(params);
            if (tabId in this.tabs && this.tabs[tabId] instanceof Tab) {
                this.tabs[tabId].setParams(params, type);
                BackgroundProxy.Logger.log("Update tab ", { tabId: tabId });
            } else {
                var t = new Tab(tabId, params, type);
                this.tabs[tabId] = t;
                BackgroundProxy.Logger.log("Add tab ", { tabId: tabId });
            }
        } catch (e) {
            BackgroundProxy.Logger.log("Error:", e);
        }
    },

    getTab: function(tabId) {
        if (tabId in this.tabs && this.tabs[tabId] instanceof Tab) {
            return this.tabs[tabId];
        }
        return null;
    },

    excludeTab: function(tabId) {
        if (this._activeTab != null && tabId == this._activeTab.tabId) this._activeTab = this._previousTab;
        if (tabId in this.excludedTabs) return;
        this.excludedTabs[tabId] = tabId;
    },

    clearTab: function(tabId) {
        delete this.tabs[tabId];
    },

    set activeTab(s) {
        if (s.tabId in this.excludedTabs) return;
        this._previousTab = this._activeTab;
        this._activeTab = s;
        chrome.runtime.sendMessage({
            type: "active tab changed"
        });
    },
    get activeTab() {
        return this._activeTab;
    },

    ////////////////////////////////////
    set settings(s) {
        this._settings = s;
    },
    get settings() {
        return this._settings;
    },
    updateSettings(path, value) {
        this._settings = this.Utils.jsonSetValueByPath(this._settings, path, value);
        chrome.storage.local.set({ "pentestkit_settings": this._settings });
    },
    resetSettings: function() {
        this._settings = new Settings();
        chrome.storage.local.set({ "pentestkit_settings": this._settings });
    },

    Request: new Request(),
    Utils: new Utils(),
    Logger: new Logger(),
    eXHeaders: new eXHeaders(),
    ////////////////////////////////////
    /* Browser Actions */
    ////////////////////////////////////
    BrowserActions: {

        isTabsCapturingActive: false,
        isHeadersControlActive: false,
        isTrafficRecordingActive: false,
        isMacroRecordingActive: false,

        activateTabsCapturing: function(info, tab) {
            BackgroundProxy.BrowserActions.isTabsCapturingActive = true;
            chrome.contextMenus.update('activateTabsCapturing', { "title": "Deactivate Tabs Capturing", "onclick": BackgroundProxy.BrowserActions.deactivateTabsCapturing });
        },

        deactivateTabsCapturing: function(info, tab) {
            BackgroundProxy.BrowserActions.isTabsCapturingActive = false;
            chrome.contextMenus.update('activateTabsCapturing', { "title": "Activate Tabs Capturing", "onclick": BackgroundProxy.BrowserActions.activateTabsCapturing });
        },

        activateHeadersControl: function(info, tab) {
            BackgroundProxy.BrowserActions.isHeadersControlActive = true;
            chrome.contextMenus.update('activateHeadersControl', { "title": "Deactivate Headers Control", "onclick": BackgroundProxy.BrowserActions.deactivateHeadersControl });
        },

        deactivateHeadersControl: function(info, tab) {
            BackgroundProxy.BrowserActions.isHeadersControlActive = false;
            chrome.contextMenus.update('activateHeadersControl', { "title": "Activate Headers Control", "onclick": BackgroundProxy.BrowserActions.activateHeadersControl });
        },

        openInNewWindow: function(info, tab) {
            chrome.windows.create({ url: chrome.extension.getURL("browser/index.html"), type: "popup" },
                function(win) {
                    BackgroundProxy.excludeTab(win.tabs[0].id);
                });
        }

    }, //end Browser Actions

}; //end BackgroundProxy



////////////////////////////////////
/* Chrome runtime events handlers */
////////////////////////////////////
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
    if (request.type == "init") {}
});

chrome.runtime.onInstalled.addListener(function() {
    var settings = new Settings();
    chrome.storage.local.set({ "pentestkit_settings": settings }, function() {
        BackgroundProxy.settings = settings;
    });
    chrome.contextMenus.removeAll(function() {
        chrome.contextMenus.create({ "id": "activateTabsCapturing", "title": "Activate Tabs Capturing", "contexts": ["browser_action"], "onclick": BackgroundProxy.BrowserActions.activateTabsCapturing });
        chrome.contextMenus.create({ "id": "activateHeadersControl", "title": "Activate Headers Control", "contexts": ["browser_action"], "onclick": BackgroundProxy.BrowserActions.activateHeadersControl });
        chrome.contextMenus.create({ "id": "activateTrafficRecording", "title": "Activate Traffic Recording", "contexts": ["browser_action"], "enabled": false, "onclick": BackgroundProxy.BrowserActions.activateTrafficRecording });
        chrome.contextMenus.create({ "id": "activateMacroRecording", "title": "Activate Macro Recording", "contexts": ["browser_action"], "enabled": false, "onclick": BackgroundProxy.BrowserActions.activateMacroRecording });
        chrome.contextMenus.create({ "type": 'separator', "contexts": ["browser_action"] });
        chrome.contextMenus.create({ "title": "Open in new window", "contexts": ["browser_action"], "onclick": BackgroundProxy.BrowserActions.openInNewWindow });
    });
    chrome.storage.local.get('pentestkit_headers', function(result) {
        if (result.pentestkit_headers) {
            BackgroundProxy.eXHeaders.headers = result.pentestkit_headers;
        }
        
    });
    BackgroundProxy.Logger.log("onInstalled", "");
});


///////////////////////////////////
/*  Chrome tabs events handlers  */
///////////////////////////////////
chrome.tabs.onActivated.addListener(function(info) {
    BackgroundProxy.Logger.log("onActivated", { tabId: info.tabId, window: info.windowId, info: info });
    BackgroundProxy.activeTab = { tabId: info.tabId, window: info.windowId };
});

chrome.tabs.onUpdated.addListener(function(tabId, info, tab) {
    if (info.status != "complete") return;
    BackgroundProxy.Logger.log("onUpdated", { tabId: tabId });
});

chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {

});


/////////////////////////////////////////
/*  Chrome webRequest events handlers  */
/////////////////////////////////////////
chrome.webRequest.onBeforeRequest.addListener(function(request) {
    //if (request.type == 'main_frame') BackgroundProxy.clearTab(request.tabId);
    BackgroundProxy.Logger.log("onBeforeRequest", { tabId: request.tabId, request: request.requestId, request: request });
    BackgroundProxy.setTab(request.tabId, request, 'start');
}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ["blocking", "requestBody"]);

////////////////////////////////
chrome.webRequest.onBeforeSendHeaders.addListener(function(request) {


}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ["requestHeaders"]);

////////////////////////////////
chrome.webRequest.onSendHeaders.addListener(function(request) {
    BackgroundProxy.Logger.log("onSendHeaders", { tabId: request.tabId, request: request.requestId, request: request });
    BackgroundProxy.setTab(request.tabId, request, 'request');

}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ["requestHeaders"]);

////////////////////////////////
chrome.webRequest.onHeadersReceived.addListener(function(response) {

}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ['responseHeaders']);

////////////////////////////////
chrome.webRequest.onBeforeRedirect.addListener(function(response) {
    BackgroundProxy.Logger.log("onBeforeRedirect", { tabId: response.tabId, request: response.requestId, response: response });
    BackgroundProxy.setTab(response.tabId, response, 'redirect');
}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ['responseHeaders']);

////////////////////////////////
chrome.webRequest.onResponseStarted.addListener(function(response) {

}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ["responseHeaders"]);

////////////////////////////////
chrome.webRequest.onCompleted.addListener(function(response) {
    BackgroundProxy.Logger.log("onCompleted", { tabId: response.tabId, request: response.requestId, response: response });
    BackgroundProxy.setTab(response.tabId, response, 'response');

}, {
    urls: ["<all_urls>"],
    types: filter_types
}, ["responseHeaders"]);

////////////////////////////////
chrome.webRequest.onErrorOccurred.addListener(function(details) {
    // console.error(details.error);
}, {
    urls: ["<all_urls>"],
    types: filter_types
});