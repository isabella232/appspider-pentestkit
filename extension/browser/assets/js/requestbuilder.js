/* Author: Denis Podgurskii */
'use strict';

$(document).ready(function() {

    $('.rbsettings').on('click', function() {
        $('.request_forms_container').hide("slow");
        $('.request_settings_container').show("slow");
    });
    $('.icon_backsettings').on('click', function() {
        $('.request_settings_container').hide("slow");
        $('.request_forms_container').show("slow");
    });

    $('#add_request').on('click', function() {
        $('.ui.inverted.dimmer').addClass('active');
        var lastId = 'original',
            lastIndex = 0;
        $('#request_tabs .request_tab').each(function(i, obj) {
            lastId = $(obj).attr('id');
            var i = parseInt($(obj).attr('index'));
            lastIndex = i > lastIndex ? i : lastIndex;
            $(obj).removeClass('active');
        });
        lastIndex = lastIndex + 1;

        $(".ui.tab.active").removeClass('active');
        $("#request_original").
        clone().
        attr('id', 'request_' + lastIndex).
        attr('data-tab', 'tab_' + lastIndex).
        addClass('active').
        appendTo("#request_forms");
        var newItem = '<a class="request_tab item active" ' +
            'index="' + lastIndex + '" id="tab_' + lastIndex + '" data-tab="tab_' + lastIndex + '"><span>Request</span><i class="window close icon"></i></a>';
        $('#' + lastId).after(newItem);

        $('#request_tabs .item').tab();
        $(document).trigger("initEvents", lastIndex);
        $(document).trigger("resetForm", 'request_' + lastIndex);
        setTimeout(function() {
            $('.ui.inverted.dimmer').removeClass('active');
        }, 200);

    });


    $(document).trigger("initEvents", 'original');
    $(document).trigger("resetForm", 'request_original');

    var params = new URLSearchParams(window.location.search);
    if (params.has('frameId') && params.has('requestId')) {
        var index = parseInt(params.get('index')),
            requestId = params.get('requestId'),
            frameId = parseInt(params.get('frameId')),
            tab = bgProxy.getTab(bgProxy.activeTab.tabId),
            request = tab.frames.get(frameId).get(requestId)[index];

        $(document).trigger("initForm", request);
    }

});

$(document).on("initEvents", function(e, data) {
    $('.reset').on('click', function() {
        $(document).trigger("resetForm", $(this).closest('.ui.tab.active').attr('id'));
    });

    $('.send').on('click', function() {
        $(document).trigger("sendRequest", $(this).closest('.ui.tab.active').attr('id'));
    });

    $('.window.close.icon').on('click', function() {
        $('.ui.inverted.dimmer').addClass('active');
        $(document).trigger("removeTab", $(this).parent().attr('index'));
        setTimeout(function() {
            $('.ui.inverted.dimmer').removeClass('active');
        }, 200);
    });
    $('.request_tab span').on('dblclick', function() {
        $(this).attr('contentEditable', true);
        $(this).focus();
    });

    $('.request_tab span').on('blur', function() {
        $(this).attr('contentEditable', false);
    });

    $("[name=request]").unbind('paste change');
    $("[name=request]").bind('paste change', null, function(e) {
        var formId = $(this).closest('.ui.tab.active').attr('id');
        setTimeout(function() {
            $(document).trigger("parseRequest", formId);
        }, 100);
    });
});

$(document).on("removeTab", function(e, index) {
    $('[data-tab=tab_' + index + ']').remove();
    $(".ui.tab.active").removeClass('active');
    $(".request_tab").removeClass('active');
    $('[data-tab=tab_original]').addClass('active');
    $('#request_original').addClass('active');
});

$(document).on("resetForm", function(e, formId) {
    var $form = $('#' + formId + ' #request_form');
    $form.form('clear');
    $form.form('set values', { 'request_method': 'GET', 'request_protocol': 'HTTP' });

    $form.form({
        fields: {
            request_method: {
                identifier: 'request_method',
                rules: [{ type: 'empty' }]
            },
            request_protocol: {
                identifier: 'request_protocol',
                rules: [{ type: 'empty' }]
            },
            request_url: {
                identifier: 'request_url',
                rules: [{
                    type: 'regExp',
                    value: /(^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$)|(^((?!:\/\/)([[a-zA-Z]{1,}[0-9]?]+\.)?([a-zA-Z0-9-]+\.){1,}[a-zA-Z]{2,30})$)/i,
                }]
            },
            request_port: {
                identifier: 'request_port',
                rules: [{ type: 'integer' }]
            },
            request: {
                identifier: 'request',
                rules: [{ type: 'empty' }]
            }
        }
    });

});

$(document).on("initForm", function(e, request) {
    if (request && request.requestHeaders) {
        var parser = document.createElement('a');
        parser.href = request.url;

        var protocol = request.url.indexOf('https://') < 0 ? 'http' : 'https';
        var path = request.method + ' ' + request.url.replace(protocol + '://' + parser.hostname, '') + ' HTTP/1.1';
        var headersStr = path + '\n' + request.requestHeaders.map(x => x.name + ": " + x.value).join('\n')
        if(headersStr.indexOf('Host:') < 0 ){
            headersStr += "\nHost: " + parser.hostname;
        }
        
        if (request.requestBody && request.requestBody.formData) {
            var params = Object.keys(request.requestBody.formData).map(function(k) {
                return encodeURIComponent(k) + '=' + encodeURIComponent(request.requestBody.formData[k])
            }).join('&')
            headersStr += "\n\n" + params;
        }


        var $form = $('#request_original #request_form');
        $form.form('set values', {
            'request_method': request.method,
            'request_protocol': protocol,
            'request': headersStr,
            'request_url': parser.hostname,

        });
    }
});

$(document).on("parseRequest", function(e, formId) {
    var $form = $('#' + formId + ' #request_form');
    var request = $form.form('get value', 'request');
    var schema = bgProxy.Request.parseRequestString(request);
    $form.form('set value', 'request_method', schema.request.method);
    $form.form('set value', 'request_url', schema.uri.url);
    $form.form('set value', 'request_port', schema.uri.port);
});

$(document).on("sendRequest", function(e, formId) {
    var schema = {};
    var $form = $('#' + formId + ' #request_form');
    $form.form('set value', 'response_headers', '');
    $form.form('set value', 'response_body', '');

    var protocol = $form.form('get value', 'request_protocol'),
        port = $form.form('get value', 'request_port');
    if (protocol == 'http' && (port == "" || port == 443)) {
        $form.form('set value', 'request_port', 80);
    }
    if (protocol == 'https' && (port == "" || port == 80)) {
        $form.form('set value', 'request_port', 443);
    }

    $form.form('validate form');

    if ($form.form('is valid')) {
        var values = $form.form('get values');
        var requestPost = values.request.split(/\r?\n\r?\n/);

        var schema = bgProxy.Request.parseRequestString(values.request, values);

        bgProxy.Request.send(schema,
            function(schema) {
                $form.form('set value', 'response_headers', schema.response.headers.map(x => x.key + ": " + x.value).join('\n'));
                $form.form('set value', 'response_body', schema.response.content);
            },
            function(xhr) {
                console.log('error');
                console.log(xhr);
            });
    }
});