"use strict";

$(document).ready(function() {

    $('#request_form').form({
        fields: {
            header_name: {
                identifier: 'header_name',
                rules: [{ type: 'empty' }]
            }
        }
    });

    $('#response_form').form({
        fields: {
            header_name: {
                identifier: 'header_name',
                rules: [{ type: 'empty' }]
            }
        }
    });

    $('#add_rule').click(function() {
        var $id = '#' + $(this).closest('form')[0].id,
            $form = $($id),
            values = $form.form('get values');

        $($id).form('validate form');

        if ($($id).form('is valid')) {
            if ($id == '#request_form') {
                bgProxy.eXHeaders.add('request', values);
                setTimeout(function() { $(document).trigger("bindRequestHeaders") }, 100);
            }else{
                bgProxy.eXHeaders.add('response', values);
                setTimeout(function() { $(document).trigger("bindRequestHeaders") }, 100);
            }
            console.log(bgProxy.eXHeaders.getHeaders());
        }
        
    });

    $('.request_clean').click(function() {
        bgProxy.eXHeaders.clean({ type: 'request' });
        setTimeout(function() { $(document).trigger("bindRequestHeaders") }, 100);
    });

    $('.operation').on('change', function() {
        if ($(this).dropdown('get value') == "remove") {
            $(this).closest('form').find('input[name=header_value]').hide("slow").val("");
        } else {
            $(this).closest('form').find('input[name=header_value]').show("slow")
        }
    });

    $(document).trigger("bindRequestHeaders");
});

$(document).on("bindRequestHeaders", function() {
    var headers = bgProxy.eXHeaders.getHeaders();
    var dt = new Array();
    for (var i in headers.request) {
        var row = headers.request[i];

        dt.push([i, row.type, row.header_name, row.matchstring]);
    }

    var params = {
        "data": dt,
        "order": [
            [1, "asc"]
        ],
        "columns": [{ "visible": false }, { title: "Type" }, { title: "Header name" }, { title: "Match string" },
            {
                render: function(data, type, row) {
                    return '<button type="button" class="request_details">Delete</button>';
                }
            }
        ]
    };
    params.paging = false;
    params.info = false;
    params.searching = false;

    var id = '#tbl_requestheaders';
    if ($.fn.dataTable.isDataTable(id)) {
        var table = $(id).DataTable();
        table.clear().rows.add(params.data).draw();
    } else {
        $(id).DataTable(params);
    }
    $(document).trigger("bindEvents");
});


$(document).on("bindEvents", function() {
    $('button.request_details').click(function() {
        var table = $(this).closest('table').DataTable(),
            tr = $(this).closest('tr'),
            row = table.row(tr),
            values = table.row($(this).parents('tr')).data();
        bgProxy.eXHeaders.remove({ type: 'request', index: values[0] });
        setTimeout(function() { $(document).trigger("bindRequestHeaders") }, 100);
    });
});