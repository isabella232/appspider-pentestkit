/* Author: Denis Podgurskii */
'use strict';

var isAllowedIncognito = false, isIncognitoTab = false;
$(document).ready(function () {

    chrome.extension.isAllowedIncognitoAccess(function (isAllowedAccess) {
        if (isAllowedAccess) {
            isAllowedIncognito = true;
        }
    });

    var editor = CodeMirror.fromTextArea(document.getElementById('recording_output'), {
        lineNumbers: true,
        lineWrapping: true,
        mode: "application/xml",
        indentUnit: 6,
        scrollbarStyle: null,
        extraKeys: { "Ctrl-Y": function (cm) { cm.foldCode(cm.getCursor()); } },
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
    });
    editor.setSize('auto', '509px');



    editor.on('change', e => {
        var currentVal = editor.getValue();;
        if (currentVal == bgProxy.Recorder.savedMacro) {
            return;
        }
        bgProxy.Recorder.savedMacro = currentVal;
    });

    var $form = $('#macro_form');

    macroController.init($form, editor);

    chrome.tabs.query({
        active: true,
        lastFocusedWindow: true
    }, function (tabs) {
        var tab = tabs[0];
        if(!tab.url.startsWith('chrome://') )$form.form('set value', 'url', tab.url);
        if (tab.incognito) {
            $('.incognito_recording').prop("disabled", true);
            isIncognitoTab = true;
        }
    });

    $('.incognito_recording').on('click', function () {
        if (!isAllowedIncognito) {
            //disabled
        } else {
            chrome.tabs.query({
                active: true,
                lastFocusedWindow: true
            }, function (tabs) {
                var tab = tabs[0];
                chrome.windows.create({ "url": tab.url, "incognito": true });
            });
        }
    });

    $('.start').on('click', function (cleanCookie = false) {
        macroController.start(false);
    });

    $('.start_clean_cookie').on('click', function () {
        macroController.start(true);
    });

    $('.reset_recording').on('click', function () {
        var values = $form.form('get values');
        $form.form('set value', 'recording_output', '');
        editor.setValue('');
        $('form').form('reset');
        $('[name="playback_regex"]').prop('disabled', true);
        $('.iframeSign').removeClass("display");
        $form.form('set value', 'url', values['url']);
        bgProxy.Recorder.reset();
    });

    ///////// Macro /////////

    $("input[name='element_path']").on('change', function () {
        bgProxy.Recorder.elementPath = this.value;
    });

    $("input[name='event_type']").on('change', function () {
        bgProxy.Recorder.eventType = this.value;
        if (this.value == "Javascript") {
            $('[name="element_path"]').prop('disabled', true);
        } else {
            $('[name="element_path"]').prop('disabled', false);
        }
    });

    $("input[name='min_duration']").on('change', function () {
        bgProxy.Recorder.minDuration = this.value;
    });

    $("input[name='playback_regex']").on('change', function () {
        bgProxy.Recorder.playbackRegex = this.value;
    });

    $("input[name='enable_regex']").on('change', function () {
        var values = $form.form('get values');
        if (values['enable_regex'] == 'on')
            $("input[name='playback_regex']").prop('disabled', false);
        else {
            $("input[name='playback_regex']").prop('disabled', true);
        }
        bgProxy.Recorder.enableRegex = (values['enable_regex'] == 'on' ? true : false);
    });

    $('.macro_export').on('click', function () {
        
        $form.form({
            inline: true,
            fields: {
                min_duration: {
                    identifier: 'min_duration',
                    rules: [{
                        type: 'integer',
                        prompt: 'Please enter an integer value'
                    }]
                },
            }
        });
        $form.form('validate form');
        if (!$form.form('is valid')) return;

        var values = $form.form('get values');
        values['useEncryption'] = false;

        if (bgProxy.Recorder.items.length > 0) {
            macroController.export();
        } else {
            $('#macro_error_message').text("Recorded macro is empty. Record a macro before export");
            $('.mini.modal').modal('show');
        }

    });

    $('.macro_replay').on('click', function () {
        try {
            var xml = editor.getValue(),
                xmlDoc = $.parseXML(xml),
                $xml = $(xmlDoc),
                $events = $xml.find("MacroEvent"),
                macroEvents = [],
                startUrl = null;
            $events.each(function (index) {
                var item = {
                    EventType: $(this).find('EventType').text(),
                    UseEncryptedData: $(this).find('UseEncryptedData').text(),
                    Data: $(this).find('Data').text(),
                    ElementPath: $(this).find('ElementPath').text(),
                    Duration: $(this).find('Duration').text(),
                    Enable: $(this).find('Enable').text(),
                    Optional: $(this).find('Optional').text()
                };
                if (item.EventType == 'Navigate') startUrl = item.Data;
                macroEvents.push(item);
            });

            if (macroEvents.length > 0 && startUrl != null) {
                var $form = $('#macro_form');
                var values = $form.form('get values');
                bgProxy.Recorder.replay({
                    url: startUrl,
                    events: macroEvents,
                    validateRegex: (values['enable_regex'] == 'on') ? values['playback_regex'] : null
                });
            } else {
                $('#macro_error_message').text("Recorded macro is empty. Export or copy and paste a macro to replay");
                $('.mini.modal').modal('show');
            }
        } catch (e) {
            $('#macro_error_message').text("Could not parse XML\n" + e.message);
            $('.mini.modal').modal('show');
        }
    });

    $('.macro_download').on('click', function () {
        try {
            var xml = editor.getValue();
            if (xml == "") macroController.export();;
            xml = editor.getValue();
            var xmlDoc = $.parseXML(xml),
                $xml = $(xmlDoc),
                $events = $xml.find("MacroEvent");
            if ($events.length > 0) {
                setTimeout(function () {
                    var blob = new Blob([editor.getValue()], { type: 'text/plain' });
                    var values = $form.form('get values');
                    var fName = "PenTestKitMacro.rec";

                    var downloadLink = document.createElement("a");
                    downloadLink.download = fName;
                    downloadLink.innerHTML = "Download File";
                    downloadLink.href = window.URL.createObjectURL(blob);
                    downloadLink.click();
                }, 100);
            } else {
                $('#macro_error_message').text("Recorded macro is empty. Record a macro before download");
                $('.mini.modal').modal('show');
            }
        } catch (e) {
            $('#macro_error_message').text("Could not parse XML\n" + e.message);
            $('.mini.modal').modal('show');
        }
    });

    $('.question').popup();
    $('.ui.accordion').accordion();

    if (bgProxy.Recorder.savedMacro != "") {
        var $form = $('#macro_form');
        $form.form('set value', 'recording_output', bgProxy.Recorder.savedMacro);
        editor.setOption("mode", "application/xml");
        editor.setValue(bgProxy.Recorder.savedMacro);
    } else {
        macroController.export();
    }
    macroController.checkFrames();
});

var macroController = {
    $form: null,
    editor: null,
    init: function ($form, editor) {
        this.$form = $form, this.editor = editor;
        $form.form('set value', 'element_path', bgProxy.Recorder.elementPath);
        $form.form('set value', 'min_duration', bgProxy.Recorder.minDuration);
        $form.form('set value', 'event_type', bgProxy.Recorder.eventType);
        $form.form('set value', 'playback_regex', bgProxy.Recorder.playbackRegex);
        $form.form('set value', 'enable_regex', bgProxy.Recorder.enableRegex);
        if (bgProxy.Recorder.enableRegex)
            $("input[name='playback_regex']").prop('disabled', false);
        else {
            $("input[name='playback_regex']").prop('disabled', true);
        }
    },
    export: function () {
        if (bgProxy.Recorder.items.length > 0) {
            var values = this.$form.form('get values');
            var res = bgProxy.Exporter.renderXml(bgProxy.Recorder.items, values);
            this.$form.form('set value', 'recording_output', res);
            this.editor.setOption("mode", "application/xml");
            this.editor.setValue(res);
            bgProxy.Recorder.savedMacro = res;
            this.checkFrames();
        }
    },
    checkFrames: function () {
        var values = this.$form.form('get values');
        var res = bgProxy.Exporter.renderXml(bgProxy.Recorder.items, values);
        var xml = this.editor.getValue();
        if (bgProxy.Recorder.iFramesDetected || xml.includes('<![CDATA[xpath=//IFRAME[')) {
            $('.iframeSign').addClass("display");
        }
    },
    start: function (cleanCookie) {
        this.$form.form({
            inline: true,
            fields: {
                url: {
                    identifier: 'url',
                    rules: [{
                        prompt: 'URL is required in the format http://example.com or https://120.0.0.1',
                        type: 'regExp',
                        value: /^((http|https):\/\/){1}(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])?(:+[0-9]+)?([\/\?]{1}.*)?$/i,
                    }]
                }
            }
        });
        this.$form.form('validate form');
        if (!this.$form.form('is valid')) return;

        bgProxy.Recorder.cleanCookie = cleanCookie;
        var values = this.$form.form('get values');
        bgProxy.Recorder.startMacro({ start_url: values['url'], incognito: isIncognitoTab });
        bgProxy.Recorder.savedMacro = "";
    }
};

chrome.runtime.onMessage.addListener(function (message, sender, sendResponse) {
    if (message.channel == "ptkBackgroundToPopup" && message.type == "recording completed") {
        macroController.export();
    }
});