/* Author: Denis Podgurskii */
'use strict';

var isAllowedIncognito = false, isIncognitoTab = false;
$(document).ready(function () {

    chrome.extension.isAllowedIncognitoAccess(function (isAllowedAccess) {
        if (isAllowedAccess) {
            isAllowedIncognito = true;
        }
    });


    var editor = CodeMirror.fromTextArea(document.getElementById('recording_output'), {
        lineNumbers: true,
        mode: "application/xml",
        indentUnit: 6,
        scrollbarStyle: null
    });
    editor.setSize('auto', '509px');

    var $form = $('#traffic_form');
    $form.form({
        inline: true,
        fields: {
            url: {
                identifier: 'url',
                rules: [{
                    prompt: 'URL is required in the format http://example.com or https://120.0.0.1',
                    type: 'regExp',
                    value: /^((http|https):\/\/){1}(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])?(:+[0-9]+)?([\/\?]{1}.*)?$/i,
                }]
            },
            min_duration: {
                identifier: 'min_duration',
                rules: [{
                    type: 'integer',
                    prompt: 'Please enter an integer value'
                }]
            },
        }
    });
    $form.form('set value', 'element_path', bgProxy.Recorder.elementPath);
    $form.form('set value', 'min_duration', bgProxy.Recorder.minDuration);

    chrome.tabs.query({
        active: true,
        lastFocusedWindow: true
    }, function (tabs) {
        var tab = tabs[0];
        if (!tab.url.startsWith('chrome://')) $form.form('set value', 'url', tab.url);
        if (tab.incognito) {
            $('.incognito_recording').prop("disabled", true);
            isIncognitoTab = true;
        }
    });

    $('.incognito_recording').on('click', function () {
        if (!isAllowedIncognito) {

        } else {
            chrome.tabs.query({
                active: true,
                lastFocusedWindow: true
            }, function (tabs) {
                var tab = tabs[0];
                chrome.windows.create({ "url": tab.url, "incognito": true });
            });
        }
    });


    $('.start').on('click', function () {
        $form.form('validate form');
        if (!$form.form('is valid')) return;

        bgProxy.Recorder.cleanCookie = false;
        var values = $form.form('get values');
        bgProxy.Recorder.startTraffic({ start_url: values['url'], incognito: isIncognitoTab });
    });

    $('.start_clean_cookie').on('click', function () {
        $form.form('validate form');
        if (!$form.form('is valid')) return;

        bgProxy.Recorder.cleanCookie = true;
        var values = $form.form('get values');
        bgProxy.Recorder.startTraffic({ start_url: values['url'], incognito: isIncognitoTab });
    });

    $('.reset_recording').on('click', function () {
        var values = $form.form('get values');
        $('form').form('reset');
        $('form').form('clear');
        $form.form('set value', 'recording_output', '');
        editor.setValue('');
        $form.form('set value', 'url', values['url']);
        $("#diagramSVG").html("");
        $("#trafficView").css("display", "block");
        $("#diagramView").css("display", "none");
        $("#auth_rating").css("display", "none");
        $("#macro_rating").attr('data-rating', 0);
        $("#traffic_rating").attr('data-rating', 0);
        $("#basic_rating").attr('data-rating', 0);
        $("#bearer_rating").attr('data-rating', 0);
        $("#token_rating").attr('data-rating', 0);

        bgProxy.Recorder.reset();
    });

    ///////// Traffic /////////
    $('.analyze').on('click', function () {
        var result = bgProxy.Recorder.analyze();
        var diagramContent = "participant Browser\n";
        $("#diagramSVG").html("");
        var cookieIn = 0, authHeaderBasicIn = 0, authHeaderBearerIn = 0, tokenIn = 0;
        if (Object.keys(result).length == 0) {
            $('#traffic_error_message').text("Recorded traffic is empty. Record a sequence or authentication to export for further analysis");
            $('.mini.modal').modal('show');
            return;
        }

        result.forEach(function (item) {
            if (item.browser) {
                if (item.browser.cookie) {
                    cookieIn++;
                    diagramContent += "Browser->Server: Host: " + item.hostname.substring(0, 30) + "...\n";
                    diagramContent += "Note right of Browser: Cookie: " + item.browser.cookie.item.value.substring(0, 20) + "...\n";
                }
                if (item.browser.authorization) {
                    if (item.browser.authorization.item.value.toLowerCase().includes('basic')) authHeaderBasicIn++;
                    else if (item.browser.authorization.item.value.toLowerCase().includes('bearer')) authHeaderBearerIn++;
                    else tokenIn++;
                    diagramContent += "Browser->Server: Host: " + item.hostname.substring(0, 30) + "...\n";
                    diagramContent += "Note right of Browser: Authorization: " + item.browser.authorization.item.value.substring(0, 15) + "...\n";
                }
            }
            if (item.server) {
                if (item.server.cookie) {
                    cookieIn++;
                    diagramContent += "Server-->Browser: Host: " + item.hostname.substring(0, 30) + "...\n";
                    diagramContent += "Note left of Server: Set-Cookie: " + item.server.cookie.item.value.substring(0, 15) + "...\n";
                }
                if (item.server.token) {
                    tokenIn++;
                    diagramContent += "Server-->Browser: Host: " + item.hostname.substring(0, 30) + "...\n";
                    diagramContent += "Note left of Server: Token: " + item.server.token.item.substring(0, 15) + "...\n";
                }
            }
        });

        if (diagramContent != "") {
            var diagram = Diagram.parse(diagramContent);
            $("#trafficView").css("display", "none");
            $("#diagramView").css("display", "block");
            $("#auth_rating").css("display", "block");

            diagram.drawSVG("diagramSVG", { theme: 'simple' });
            if (cookieIn) {
                $("#macro_rating").attr('data-rating', 5);
                $("#traffic_rating").attr('data-rating', 4);
            }
            if (authHeaderBasicIn) {
                $("#basic_rating").attr('data-rating', 5);
            }
            if (authHeaderBearerIn) {
                $("#bearer_rating").attr('data-rating', 5);
            }
            if (tokenIn) {
                $("#token_rating").attr('data-rating', 5);
            }

            $('.rating').rating('disable');
        }
    });

    $('.harview').on('click', function () {

        var outputHolderEl = document.getElementById("output")
        var pageSelectorEl = document.getElementById("page-selector")
        var outputHolder2El = document.getElementById("output2")
        var pageSelector2El = document.getElementById("page-selector2")
        var legendHolderEl = document.getElementById("legendHolder")

        bgProxy.Recorder.analyze();
        var harLog = bgProxy.Exporter.renderHar(bgProxy.Recorder.requests);
        if (harLog) {
            trafficController.setup({
                pageSelector: pageSelectorEl,
                legendHolder: legendHolderEl,
                showUserTiming: true,
                // showUserTimingEndMarker: true,
            }, "fileinput", outputHolderEl, harLog);
            $('#dialogHarView').modal('show');
        } else {
            $('#traffic_error_message').text("Recorded traffic is empty. Record a sequence or authentication to download");
            $('.mini.modal').modal('show');
            return;
        }


    });

    $('.traffic_export').on('click', function () {
        // $("#trafficView").css("display", "block");
        // $("#diagramView").css("display", "none");
        // $("#auth_rating").css("display", "none");
        bgProxy.Recorder.analyze();
        var harLog = bgProxy.Exporter.renderHar(bgProxy.Recorder.requests);
        if (harLog) {
            $form.form('set value', 'recording_output', JSON.stringify(harLog, null, 2));
            editor.setOption("mode", "javascript/json");
            editor.setValue(JSON.stringify(harLog, null, 2));
        } else {
            $('#traffic_error_message').text("Recorded traffic is empty. Record a sequence or authentication to download");
            $('.mini.modal').modal('show');
            return;
        }
    });

    $('.traffic_download').on('click', function () {
        $('.traffic_export').trigger('click');
        var blob = new Blob([editor.getValue()], { type: 'text/plain' });
        var values = $form.form('get values');
        var fName = "PenTestKitTraffic.har";

        var values = $form.form('get values');
        if (values['url'] != "") {
            var a = document.createElement('a');
            a.href = values['url'];
            fName =  'PTK_' + a.hostname + '.har';
        }
        if (blob.size > 0) {
            var downloadLink = document.createElement("a");
            downloadLink.download = fName;
            downloadLink.innerHTML = "Download File";
            downloadLink.href = window.URL.createObjectURL(blob);
            downloadLink.click();
        }
    });

    var result = bgProxy.Recorder.analyze();
    if (Object.keys(result).length > 0) {
        $('.analyze').trigger('click');
    }

});


var trafficController = {

    setup: function (options, fileinputId, outputHolder, harLog) {

        /**
            * This is where the magic happens
            */
        function renderPerfCascadeChart(logData) {
            /** remove all children of `outputHolderEl`,
             * so you can upload new HAR files and get a new SVG  */
            while (outputHolder.childNodes.length > 0) {
                outputHolder.removeChild(outputHolder.childNodes[0])
            }

            /** pass HAR and options to `newPerfCascadeHar` to generate the SVG element*/
            var perfCascadeSvg = window.perfCascade.fromHar(logData, options)

            /** append SVG to page - that's it */
            outputHolder.appendChild(perfCascadeSvg)
        }


        /** handle client side file upload via file-reader */
        function onFileSubmit(evt) {
            var files = evt.target.files
            if (!files) {
                alert("Failed to load HAR file")
                return
            }

            // Just needed for zipped *.zhar files, you can use the standard FileReader api for normal .har files
            perfCascadeFileReader.readFile(files[0], evt.target.value, function (error, data) {
                if (error) {
                    console.error(error)
                } else {
                    renderPerfCascadeChart(data)
                }
            }, function (progress) {
                console.log("unzip progress: ", progress / 100, "%");
            })
        }

        if (window["fetch"]) {/** load an initial HAR when opening the page */
            window["fetch"](harLog)
                .then(f => f.json().then(j => renderPerfCascadeChart(j.log)))
        }
        //renderPerfCascadeChart(harLog);

        /** hook up file input events */
        document.getElementById(fileinputId).addEventListener("change", onFileSubmit, false)
    }
};

chrome.runtime.onMessage.addListener(function (message, sender, sendResponse) {
    if (message.channel == "ptkBackgroundToPopup" && message.type == "recording completed") {
        var result = bgProxy.Recorder.analyze();
        if (Object.keys(result).length > 0) {
            $('.analyze').trigger('click');
        }
    }
});